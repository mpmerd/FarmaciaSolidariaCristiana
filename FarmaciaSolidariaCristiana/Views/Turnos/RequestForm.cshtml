@model FarmaciaSolidariaCristiana.Controllers.TurnoRequestViewModel
@{
    ViewData["Title"] = "Solicitar Turno";
    var medicines = ViewBag.Medicines as List<dynamic>;
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="bi bi-calendar-plus"></i> Solicitar Turno
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h5><i class="bi bi-info-circle"></i> Instrucciones</h5>
                        <ul class="mb-0">
                            <li>Completa todos los campos requeridos</li>
                            <li>Selecciona los medicamentos que necesitas</li>
                            <li>Adjunta tu documento de identidad (obligatorio)</li>
                            <li>Si tienes receta médica, adjúntala (recomendado)</li>
                            <li>Recibirás un email cuando tu solicitud sea revisada</li>
                        </ul>
                    </div>

                    <form asp-action="RequestForm" method="post" enctype="multipart/form-data" id="turnoForm">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        @* Información Personal *@
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-person"></i> Información Personal</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label asp-for="DocumentoIdentidad" class="form-label">
                                        Carnet de Identidad o Pasaporte <span class="text-danger">*</span>
                                    </label>
                                    <input asp-for="DocumentoIdentidad" class="form-control" placeholder="Ej: 88012312345 o A1234567" />
                                    <span asp-validation-for="DocumentoIdentidad" class="text-danger"></span>
                                    <small class="form-text text-muted">
                                        <i class="bi bi-info-circle"></i> 11 dígitos para CI o letra + 6-7 dígitos para Pasaporte. 
                                        <i class="bi bi-shield-lock"></i> Tu documento será encriptado por seguridad
                                    </small>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="FechaPreferida" class="form-label">
                                        Fecha y Hora Preferida del Turno <span class="text-danger">*</span>
                                    </label>
                                    <input asp-for="FechaPreferida" type="datetime-local" class="form-control" />
                                    <span asp-validation-for="FechaPreferida" class="text-danger"></span>
                                    <small class="form-text text-muted">
                                        <i class="bi bi-info-circle"></i> Los turnos solo están disponibles <strong>Martes y Viernes</strong> de <strong>1:00 PM a 4:00 PM</strong>. 
                                        Límite: 30 turnos por día. Debe ser al menos 24 horas en el futuro.
                                    </small>
                                </div>
                            </div>
                        </div>

                        @* Selección de Medicamentos *@
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-capsule"></i> Medicamentos Solicitados</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Buscar Medicamento <span class="text-danger">*</span></label>
                                    <input type="text" id="medicineSearch" class="form-control" placeholder="Escribe para buscar..." />
                                    <small class="form-text text-muted">Selecciona los medicamentos que necesitas</small>
                                </div>

                                <div id="selectedMedicines" class="mb-3">
                                    <label class="form-label">Medicamentos Seleccionados:</label>
                                    <div id="medicinesList" class="border rounded p-3 bg-light" style="min-height: 100px;">
                                        <p class="text-muted text-center mb-0" id="emptyMessage">
                                            <i class="bi bi-inbox"></i> No has seleccionado medicamentos aún
                                        </p>
                                    </div>
                                </div>

                                <div class="list-group" id="medicineResults" style="max-height: 300px; overflow-y: auto; display: none;">
                                    @if (medicines != null && medicines.Any())
                                    {
                                        @foreach (var med in medicines)
                                        {
                                            <a href="#" class="list-group-item list-group-item-action medicine-item" 
                                               data-id="@med.Id" 
                                               data-name="@med.Name" 
                                               data-stock="@med.StockQuantity"
                                               data-unit="@med.Unit">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>@med.Name</strong>
                                                    </div>
                                                    <span class="badge @(med.StockQuantity > 10 ? "bg-success" : med.StockQuantity > 5 ? "bg-warning text-dark" : "bg-danger")">
                                                        Stock: @med.StockQuantity @med.Unit
                                                    </span>
                                                </div>
                                            </a>
                                        }
                                    }
                                </div>
                            </div>
                        </div>

                        @* Documentos *@
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-file-earmark-medical"></i> Documentos</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="receta" class="form-label">
                                        Receta Médica (Opcional)
                                    </label>
                                    <input type="file" class="form-control" id="receta" name="receta" accept=".jpg,.jpeg,.png,.pdf" />
                                    <small class="form-text text-muted">Formatos: JPG, PNG, PDF (máx 5MB)</small>
                                </div>

                                <div class="mb-3">
                                    <label for="tarjeton" class="form-label">
                                        Documento de Identidad (Foto/Escaneo) <span class="text-danger">*</span>
                                    </label>
                                    <input type="file" class="form-control" id="tarjeton" name="tarjeton" accept=".jpg,.jpeg,.png,.pdf" required />
                                    <small class="form-text text-muted">Foto o escaneo de tu carnet/pasaporte (máx 5MB)</small>
                                </div>
                            </div>
                        </div>

                        @* Notas Adicionales *@
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-chat-left-text"></i> Notas Adicionales</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label asp-for="NotasSolicitante" class="form-label">Notas o Comentarios (Opcional)</label>
                                    <textarea asp-for="NotasSolicitante" class="form-control" rows="4" 
                                              placeholder="Información adicional que quieras compartir con el farmacéutico..."></textarea>
                                    <span asp-validation-for="NotasSolicitante" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <i class="bi bi-send"></i> Enviar Solicitud
                            </button>
                            <a asp-action="Index" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        // Sistema de selección de medicamentos
        let selectedMedicines = [];

        $(document).ready(function() {
            const medicineSearch = $('#medicineSearch');
            const medicineResults = $('#medicineResults');
            const medicinesList = $('#medicinesList');
            const emptyMessage = $('#emptyMessage');

            // Búsqueda de medicamentos con AJAX
            medicineSearch.on('input', function() {
                const query = $(this).val().trim();
                
                if (query.length < 2) {
                    medicineResults.empty().hide();
                    return;
                }
                
                $.ajax({
                    url: '@Url.Action("SearchMedicines", "Turnos")',
                    type: 'GET',
                    data: { query: query },
                    success: function(response) {
                        medicineResults.empty();
                        
                        if (response.medicines && response.medicines.length > 0) {
                            response.medicines.forEach(function(med) {
                                var stockBadgeClass = med.stock > 10 ? 'bg-success' : med.stock > 5 ? 'bg-warning text-dark' : 'bg-danger';
                                
                                var item = $('<a href="#" class="list-group-item list-group-item-action medicine-item"></a>')
                                    .data('id', med.id)
                                    .data('name', med.name)
                                    .data('stock', med.stock)
                                    .data('unit', med.unit || 'unidades')
                                    .html(
                                        '<div class="d-flex justify-content-between align-items-center">' +
                                        '<div><strong>' + med.name + '</strong></div>' +
                                        '<span class="badge ' + stockBadgeClass + '">Stock: ' + med.stock + ' ' + (med.unit || 'unidades') + '</span>' +
                                        '</div>'
                                    );
                                
                                medicineResults.append(item);
                            });
                            medicineResults.show();
                        } else {
                            medicineResults.html(
                                '<div class="list-group-item text-muted">No se encontraron medicamentos</div>'
                            ).show();
                        }
                    },
                    error: function() {
                        medicineResults.html(
                            '<div class="list-group-item text-danger">Error al buscar medicamentos</div>'
                        ).show();
                    }
                });
            });

            // Seleccionar medicamento (delegated event para elementos dinámicos)
            medicineResults.on('click', '.medicine-item', function(e) {
                e.preventDefault();
                
                const id = $(this).data('id');
                const name = $(this).data('name');
                const stock = $(this).data('stock');
                const unit = $(this).data('unit');

                // Verificar si ya está seleccionado
                if (selectedMedicines.find(m => m.id === id)) {
                    alert('Este medicamento ya está seleccionado');
                    return;
                }

                // Agregar a la lista
                addMedicine(id, name, stock, unit);
                
                // Limpiar búsqueda
                medicineSearch.val('');
                medicineResults.empty().hide();
                medicineSearch.val('');
                medicineResults.hide();
            });

            function addMedicine(id, name, stock, unit) {
                const medicineItem = $(`
                    <div class="card mb-2 medicine-card" data-id="${id}">
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-md-5">
                                    <strong>${name}</strong>
                                    <input type="hidden" name="medicineIds" value="${id}" />
                                </div>
                                <div class="col-md-4">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text">Cantidad</span>
                                        <input type="number" name="quantities" class="form-control quantity-input" 
                                               min="1" max="${stock}" value="1" required />
                                        <span class="input-group-text">${unit}</span>
                                    </div>
                                    <small class="text-muted">Stock disponible: ${stock}</small>
                                </div>
                                <div class="col-md-3 text-end">
                                    <button type="button" class="btn btn-sm btn-danger remove-medicine">
                                        <i class="bi bi-trash"></i> Quitar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `);

                selectedMedicines.push({ id, name, stock, unit });
                
                if (selectedMedicines.length === 1) {
                    emptyMessage.hide();
                }
                
                medicinesList.append(medicineItem);

                // Evento para quitar
                medicineItem.find('.remove-medicine').on('click', function() {
                    selectedMedicines = selectedMedicines.filter(m => m.id !== id);
                    medicineItem.remove();
                    
                    if (selectedMedicines.length === 0) {
                        emptyMessage.show();
                    }
                });

                // Validar cantidad
                medicineItem.find('.quantity-input').on('change', function() {
                    const value = parseInt($(this).val());
                    if (value > stock) {
                        alert(`La cantidad no puede ser mayor al stock disponible (${stock})`);
                        $(this).val(stock);
                    } else if (value < 1) {
                        $(this).val(1);
                    }
                });
            }

            // Validación del formulario
            $('#turnoForm').on('submit', function(e) {
                if (selectedMedicines.length === 0) {
                    e.preventDefault();
                    alert('Debes seleccionar al menos un medicamento');
                    return false;
                }
                
                // Validar fecha y hora (Martes y Viernes 1-4 PM)
                const fechaPreferida = new Date($('input[name="FechaPreferida"]').val());
                const dayOfWeek = fechaPreferida.getDay(); // 0 = Domingo, 1 = Lunes, 2 = Martes, ..., 5 = Viernes
                const hour = fechaPreferida.getHours();
                
                if (dayOfWeek !== 2 && dayOfWeek !== 5) {
                    e.preventDefault();
                    alert('Los turnos solo están disponibles los Martes y Viernes. Por favor selecciona una de estas fechas.');
                    $('#submitBtn').prop('disabled', false).html('<i class="bi bi-send"></i> Enviar Solicitud');
                    return false;
                }
                
                if (hour < 13 || hour >= 16) {
                    e.preventDefault();
                    alert('Los turnos solo están disponibles de 1:00 PM a 4:00 PM. Por favor selecciona una hora en este rango.');
                    $('#submitBtn').prop('disabled', false).html('<i class="bi bi-send"></i> Enviar Solicitud');
                    return false;
                }

                // Deshabilitar botón para evitar doble envío
                $('#submitBtn').prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Enviando...');
            });

            // Validación de archivos
            $('#receta, #tarjeton').on('change', function() {
                const file = this.files[0];
                if (file && file.size > 5 * 1024 * 1024) {
                    alert('El archivo no puede superar 5MB');
                    $(this).val('');
                }
            });

            // Establecer fecha mínima (24 horas desde ahora)
            const now = new Date();
            now.setHours(now.getHours() + 24);
            const minDate = now.toISOString().slice(0, 16);
            $('input[name="FechaPreferida"]').attr('min', minDate);
        });
    </script>
}
