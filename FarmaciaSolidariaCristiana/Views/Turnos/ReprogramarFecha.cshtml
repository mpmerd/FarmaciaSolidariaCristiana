@{
    ViewData["Title"] = "Reprogramar Turnos por Fecha";
}

<div class="container mt-4">
    <h2 class="mb-4">
        <i class="bi bi-arrow-repeat"></i> Reprogramar Turnos por Fecha
    </h2>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["WarningMessage"] != null)
    {
        <div class="alert alert-warning alert-dismissible fade show">
            <i class="bi bi-exclamation-triangle"></i> @TempData["WarningMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["InfoMessage"] != null)
    {
        <div class="alert alert-info alert-dismissible fade show">
            <i class="bi bi-info-circle"></i> @TempData["InfoMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="alert alert-warning">
        <h5><i class="bi bi-exclamation-triangle"></i> Atención</h5>
        <p><strong>Esta acción reprogramará automáticamente TODOS los turnos del día seleccionado.</strong></p>
        <ul class="mb-0">
            <li>Se buscarán automáticamente nuevos slots disponibles (Martes/Jueves 1-4 PM)</li>
            <li>Se enviará email automático a cada paciente afectado</li>
            <li>El sistema saltará fechas bloqueadas</li>
            <li>Solo se reprogramarán turnos con estado <strong>Pendiente</strong> o <strong>Aprobado</strong></li>
        </ul>
    </div>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Seleccionar Fecha a Reprogramar</h5>
        </div>
        <div class="card-body">
            <form asp-action="ReprogramarTurnosPorFecha" method="post">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Fecha a Reprogramar</label>
                            <input type="date" name="fechaAfectada" class="form-control" required />
                            <small class="text-muted">Todos los turnos de esta fecha serán reprogramados</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Motivo de la Reprogramación</label>
                            <textarea name="motivo" class="form-control" rows="4" required
                                      placeholder="Ej: Día festivo nacional, Emergencia, Mantenimiento de instalaciones, Condiciones climáticas adversas..."></textarea>
                            <small class="text-muted">Este motivo será enviado por email a todos los pacientes afectados</small>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <h6 class="alert-heading"><i class="bi bi-info-circle"></i> Proceso de Reprogramación</h6>
                            <ol class="mb-0 small">
                                <li>El sistema buscará todos los turnos del día seleccionado</li>
                                <li>Por cada turno, buscará el próximo slot disponible:
                                    <ul>
                                        <li>Solo días Martes o Jueves</li>
                                        <li>Horario: 1:00 PM - 4:00 PM</li>
                                        <li>Excluye fechas bloqueadas</li>
                                        <li>Verifica disponibilidad (máx 30 turnos/día)</li>
                                    </ul>
                                </li>
                                <li>Actualizará la fecha del turno</li>
                                <li>Enviará email al paciente con:
                                    <ul>
                                        <li>Fecha original y nueva fecha</li>
                                        <li>Motivo de la reprogramación</li>
                                        <li>Instrucciones importantes</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>
                        
                        <div class="alert alert-warning small">
                            <strong><i class="bi bi-exclamation-triangle"></i> Importante:</strong>
                            <ul class="mb-0">
                                <li>Si no hay disponibilidad en 60 días, esos turnos NO se reprogramarán</li>
                                <li>Se registrará en los comentarios del turno</li>
                                <li>Revisa el resultado después de ejecutar</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                    <a asp-controller="Home" asp-action="Dashboard" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-primary" 
                            onclick="return confirm('¿Está seguro de reprogramar TODOS los turnos de la fecha seleccionada? Esta acción enviará emails a todos los pacientes afectados.');">
                        <i class="bi bi-arrow-repeat"></i> Reprogramar Turnos
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Sección de ayuda -->
    <div class="card mt-4">
        <div class="card-header bg-secondary text-white">
            <h6 class="mb-0"><i class="bi bi-question-circle"></i> Casos de Uso</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h6><i class="bi bi-calendar-x text-danger"></i> Días Festivos</h6>
                    <p class="small text-muted">
                        Cuando se declara un día festivo después de haber aprobado turnos.
                    </p>
                </div>
                <div class="col-md-4">
                    <h6><i class="bi bi-exclamation-triangle text-warning"></i> Emergencias</h6>
                    <p class="small text-muted">
                        Situaciones imprevistas que impiden operar en la fecha programada.
                    </p>
                </div>
                <div class="col-md-4">
                    <h6><i class="bi bi-tools text-info"></i> Mantenimiento</h6>
                    <p class="small text-muted">
                        Trabajos de mantenimiento en las instalaciones de la farmacia.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3 text-muted small">
        <p><strong>Nota:</strong> Esta funcionalidad solo está disponible para usuarios con rol <strong>Admin</strong>.</p>
        <p>Para bloquear fechas futuras y prevenir que se asignen nuevos turnos, usa la opción 
           <a asp-controller="FechasBloqueadas" asp-action="Index">Gestión de Fechas Bloqueadas</a>.</p>
    </div>
</div>
