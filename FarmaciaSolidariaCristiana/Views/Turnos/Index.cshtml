@{
    ViewData["Title"] = "Sistema de Turnos";
    var userTurnos = ViewData["UserTurnos"] as List<FarmaciaSolidariaCristiana.Models.Turno>;
    var canRequest = ViewData["CanRequestTurno"] as bool? ?? false;
    var cannotRequestReason = ViewData["CannotRequestReason"] as string;
    var availableMedicines = ViewData["AvailableMedicines"] as List<FarmaciaSolidariaCristiana.Models.Medicine>;
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="bi bi-calendar-check"></i> Sistema de Turnos
                    </h3>
                </div>
                <div class="card-body">
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show">
                            <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                    
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show">
                            <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <div class="alert alert-info">
                        <h5><i class="bi bi-info-circle"></i> Bienvenido al Sistema de Turnos</h5>
                        <p class="mb-0">
                            Solicita tu turno para retirar medicamentos de forma ordenada. 
                            Nuestro sistema te asigna un número de turno y recibirás notificación por email.
                        </p>
                    </div>

                    @if (User.IsInRole("ViewerPublic"))
                    {
                        <!-- Buscar Medicamentos Antes de Solicitar -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="card border-info">
                                    <div class="card-body">
                                        <h5 class="card-title"><i class="bi bi-search"></i> Buscar Medicamentos Disponibles</h5>
                                        <p class="text-muted small mb-3">
                                            Verifica la disponibilidad antes de solicitar tu turno
                                        </p>
                                        <div class="input-group mb-3">
                                            <span class="input-group-text"><i class="bi bi-capsule"></i></span>
                                            <input type="text" 
                                                   id="searchMedicineIndex" 
                                                   class="form-control" 
                                                   placeholder="Buscar por nombre de medicamento..."
                                                   autocomplete="off">
                                        </div>
                                        <div id="searchResultsIndex" class="list-group"></div>
                                        <div id="medicineInfoIndex" style="display: none;" class="alert alert-success mt-3">
                                            <h6 class="alert-heading"><i class="bi bi-info-circle"></i> Información del Medicamento</h6>
                                            <p class="mb-1"><strong>Nombre:</strong> <span id="medicineNameIndex"></span></p>
                                            <p class="mb-1"><strong>Disponible:</strong> <span id="medicineStockIndex" class="badge bg-success"></span></p>
                                            <p class="mb-0"><strong>Descripción:</strong> <span id="medicineDescIndex"></span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="card border-primary">
                                    <div class="card-body text-center">
                                        <h4 class="card-title">¿Necesitas medicamentos?</h4>
                                        @if (canRequest)
                                        {
                                            <p class="card-text">Puedes solicitar un turno ahora mismo.</p>
                                            <a asp-action="RequestForm" class="btn btn-primary btn-lg">
                                                <i class="bi bi-plus-circle"></i> Solicitar Turno
                                            </a>
                                            <p class="text-muted mt-2 small">
                                                <i class="bi bi-shield-check"></i> Límite: 2 turnos por mes
                                            </p>
                                            <div class="alert alert-warning mt-3 mb-0" role="alert">
                                                <i class="bi bi-info-circle-fill"></i>
                                                <strong>Importante:</strong> Los tratamientos se ofrecerán por un período máximo de 15 días. 
                                                De manera excepcional, podrán ser valorados hasta 21 días, sin garantía de aprobación.
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="alert alert-warning mb-0">
                                                <i class="bi bi-exclamation-triangle"></i> @cannotRequestReason
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        @if (userTurnos != null && userTurnos.Any())
                        {
                            <h4 class="mt-4 mb-3"><i class="bi bi-clock-history"></i> Mis Turnos</h4>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Número</th>
                                            <th>Tipo</th>
                                            <th>Estado</th>
                                            <th>Fecha Solicitud</th>
                                            <th>Fecha Turno</th>
                                            <th>Items</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var turno in userTurnos)
                                        {
                                            var hasMedicines = turno.Medicamentos != null && turno.Medicamentos.Any();
                                            var hasSupplies = turno.Insumos != null && turno.Insumos.Any();
                                            
                                            <tr>
                                                <td>
                                                    @if (turno.NumeroTurno.HasValue)
                                                    {
                                                        <span class="badge bg-dark" style="font-size: 1.1em;">
                                                            #@turno.NumeroTurno.Value.ToString("000")
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">-</span>
                                                    }
                                                </td>
                                                <td>
                                                    @if (hasMedicines)
                                                    {
                                                        <span class="badge bg-primary">
                                                            <i class="bi bi-capsule"></i> Medicamentos
                                                        </span>
                                                    }
                                                    else if (hasSupplies)
                                                    {
                                                        <span class="badge bg-info">
                                                            <i class="bi bi-box-seam"></i> Insumos
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">-</span>
                                                    }
                                                </td>
                                                <td>
                                                    @switch (turno.Estado)
                                                    {
                                                        case "Pendiente":
                                                            <span class="badge bg-warning text-dark">
                                                                <i class="bi bi-hourglass-split"></i> Pendiente
                                                            </span>
                                                            break;
                                                        case "Aprobado":
                                                            <span class="badge bg-success">
                                                                <i class="bi bi-check-circle"></i> Aprobado
                                                            </span>
                                                            break;
                                                        case "Rechazado":
                                                            <span class="badge bg-danger">
                                                                <i class="bi bi-x-circle"></i> Rechazado
                                                            </span>
                                                            break;
                                                        case "Completado":
                                                            <span class="badge bg-info">
                                                                <i class="bi bi-check-all"></i> Completado
                                                            </span>
                                                            break;
                                                        default:
                                                            <span class="badge bg-secondary">@turno.Estado</span>
                                                            break;
                                                    }
                                                </td>
                                                <td>@turno.FechaSolicitud.ToString("dd/MM/yyyy HH:mm")</td>
                                                <td>@(turno.FechaPreferida?.ToString("dd/MM/yyyy HH:mm") ?? "Por asignar")</td>
                                                <td>
                                                    <small>
                                                        @if (hasMedicines)
                                                        {
                                                            @foreach (var med in turno.Medicamentos!.Take(2))
                                                            {
                                                                <span class="badge bg-light text-dark">@med.Medicine?.Name</span>
                                                            }
                                                            @if (turno.Medicamentos!.Count > 2)
                                                            {
                                                                <span class="badge bg-secondary">+@(turno.Medicamentos.Count - 2) más</span>
                                                            }
                                                        }
                                                        else if (hasSupplies)
                                                        {
                                                            @foreach (var ins in turno.Insumos!.Take(2))
                                                            {
                                                                <span class="badge bg-light text-dark">@ins.Supply?.Name</span>
                                                            }
                                                            @if (turno.Insumos!.Count > 2)
                                                            {
                                                                <span class="badge bg-secondary">+@(turno.Insumos.Count - 2) más</span>
                                                            }
                                                        }
                                                    </small>
                                                </td>
                                                <td>
                                                    @if (turno.Estado == "Aprobado" && turno.FechaPreferida.HasValue)
                                                    {
                                                        var diasRestantes = (turno.FechaPreferida.Value.Date - DateTime.Now.Date).Days;
                                                        
                                                        if (diasRestantes > 7)
                                                        {
                                                            <button type="button" class="btn btn-sm btn-warning" 
                                                                    data-bs-toggle="modal" 
                                                                    data-bs-target="#cancelModal"
                                                                    data-turno-id="@turno.Id"
                                                                    data-turno-numero="@turno.NumeroTurno"
                                                                    data-turno-fecha="@turno.FechaPreferida?.ToString("dd/MM/yyyy HH:mm")">
                                                                <i class="bi bi-x-circle"></i> Cancelar
                                                            </button>
                                                            <small class="text-muted d-block mt-1">Faltan @diasRestantes días</small>
                                                        }
                                                        else
                                                        {
                                                            <small class="text-muted">
                                                                <i class="bi bi-info-circle"></i> 
                                                                No cancelable<br/>
                                                                (menos de 7 días)
                                                            </small>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">-</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            
                            @* Modal de confirmación de cancelación *@
                            <div class="modal fade" id="cancelModal" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <form asp-action="Cancel" method="post">
                                            @Html.AntiForgeryToken()
                                            <div class="modal-header bg-warning">
                                                <h5 class="modal-title">Cancelar Turno</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <input type="hidden" name="id" id="turnoId" />
                                                
                                                <div class="alert alert-warning">
                                                    <i class="bi bi-exclamation-triangle"></i>
                                                    <strong>¿Estás seguro?</strong><br/>
                                                    Vas a cancelar el turno <strong>#<span id="turnoNumero"></span></strong><br/>
                                                    Fecha: <strong><span id="turnoFecha"></span></strong>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label class="form-label">
                                                        <strong>Motivo de la cancelación:</strong>
                                                        <span class="text-danger">*</span>
                                                    </label>
                                                    <textarea name="motivoCancelacion" 
                                                              class="form-control" 
                                                              rows="3" 
                                                              required
                                                              placeholder="Por favor, explica por qué necesitas cancelar el turno..."></textarea>
                                                    <small class="text-muted">Este campo es obligatorio</small>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    No, mantener turno
                                                </button>
                                                <button type="submit" class="btn btn-warning">
                                                    <i class="bi bi-x-circle"></i> Sí, cancelar turno
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-light border mt-4">
                                <i class="bi bi-inbox"></i> No tienes turnos solicitados aún.
                            </div>
                        }
                    }
                </div>
            </div>

            @* Información de stock disponible *@
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="bi bi-box-seam"></i> Medicamentos Disponibles</h4>
                </div>
                <div class="card-body">
                    @if (availableMedicines != null && availableMedicines.Any())
                    {
                        <div class="row">
                            @foreach (var medicine in availableMedicines.Take(12))
                            {
                                <div class="col-md-4 col-sm-6 mb-3">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title">@medicine.Name</h6>
                                            <p class="card-text mb-1">
                                                <small class="text-muted">Stock:</small>
                                                <span class="badge @(medicine.StockQuantity > 10 ? "bg-success" : medicine.StockQuantity > 5 ? "bg-warning text-dark" : "bg-danger")">
                                                    @medicine.StockQuantity @medicine.Unit
                                                </span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        @if (availableMedicines.Count > 12)
                        {
                            <p class="text-center text-muted mt-3">
                                Y @(availableMedicines.Count - 12) medicamentos más disponibles...
                            </p>
                        }
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-circle"></i> No hay medicamentos disponibles en este momento.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Autocomplete para buscar medicamentos en Index
            $('#searchMedicineIndex').on('input', function() {
                var query = $(this).val().trim();
                
                if (query.length < 2) {
                    $('#searchResultsIndex').empty();
                    $('#medicineInfoIndex').hide();
                    return;
                }
                
                $.ajax({
                    url: '@Url.Action("SearchMedicines", "Turnos")',
                    type: 'GET',
                    data: { query: query },
                    success: function(response) {
                        $('#searchResultsIndex').empty();
                        $('#medicineInfoIndex').hide();
                        
                        if (response.medicines && response.medicines.length > 0) {
                            response.medicines.forEach(function(med) {
                                var stockBadge = med.stock > 0 
                                    ? '<span class="badge bg-success">Disponible: ' + med.stock + '</span>'
                                    : '<span class="badge bg-danger">Sin stock</span>';
                                
                                var item = $('<a href="#" class="list-group-item list-group-item-action medicine-item-index"></a>')
                                    .data('medicine', med)
                                    .html('<strong>' + med.name + '</strong><br>' +
                                          '<small class="text-muted">' + (med.description || 'Sin descripción') + '</small> ' +
                                          stockBadge);
                                
                                $('#searchResultsIndex').append(item);
                            });
                        } else {
                            $('#searchResultsIndex').html(
                                '<div class="list-group-item text-muted">No se encontraron medicamentos</div>'
                            );
                        }
                    },
                    error: function() {
                        $('#searchResultsIndex').html(
                            '<div class="list-group-item text-danger">Error al buscar medicamentos</div>'
                        );
                    }
                });
            });
            
            // Mostrar información del medicamento seleccionado
            $(document).on('click', '.medicine-item-index', function(e) {
                e.preventDefault();
                var med = $(this).data('medicine');
                
                $('#medicineNameIndex').text(med.name);
                $('#medicineStockIndex').text(med.stock + ' unidades');
                $('#medicineDescIndex').text(med.description || 'Sin descripción');
                
                if (med.stock > 0) {
                    $('#medicineInfoIndex').removeClass('alert-danger').addClass('alert-success');
                    $('#medicineStockIndex').removeClass('bg-danger').addClass('bg-success');
                } else {
                    $('#medicineInfoIndex').removeClass('alert-success').addClass('alert-danger');
                    $('#medicineStockIndex').removeClass('bg-success').addClass('bg-danger');
                }
                
                $('#medicineInfoIndex').show();
                $('#searchResultsIndex').empty();
            });
            
            // Script para pasar datos al modal de cancelación
            var cancelModal = document.getElementById('cancelModal');
            if (cancelModal) {
                cancelModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    var turnoId = button.getAttribute('data-turno-id');
                    var turnoNumero = button.getAttribute('data-turno-numero');
                    var turnoFecha = button.getAttribute('data-turno-fecha');
                    
                    document.getElementById('turnoId').value = turnoId;
                    document.getElementById('turnoNumero').textContent = turnoNumero;
                    document.getElementById('turnoFecha').textContent = turnoFecha;
                });
            }
        });
    </script>
}
